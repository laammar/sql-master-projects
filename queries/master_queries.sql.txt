-- Tarea bases de datos SQL: Carlos Lara Marín 77767539P

-- CONTEXTO ESTABLECIDO CLICKANDO

-- SMART DESK: Análisis financiero 2019-2021 y oportunidades 2022
-- Análisis exploratorio

SELECT * FROM SALES;
SELECT * FROM ACCOUNTS;
SELECT * FROM FORECASTS;

-- *Como anotación, a lo largo de las 4 diferentes consultas problema y el caso práctico previamente dejo alguna consulta que utilizo yo como análisis exploratorio para guiarme previamente a la consulta solución.

-- CONSULTAS

-- 1.Análisis de ventas y beneficios por categoría de producto

-- QUERY SOLUCION:

SELECT 
CATEGORY AS CATEGORIA, 
SUM(MAINTENANCE) AS MANTENIMIENTO, 
SUM(PRODUCT) AS PRODUCTO, 
SUM(PARTS) AS PARTES, 
SUM(SUPPORT) AS SOPORTE, 
SUM(TOTAL) AS TOTAL_VENTAS, 
SUM(UNITS_SOLD) AS UNIDADES_VENDIDAS, 
SUM(PROFIT) AS BENEFICIO_TOTAL
FROM SALES

WHERE ACCOUNT = 'Adabs Entertainment'
AND YEAR = 2020

GROUP BY CATEGORY
ORDER BY CATEGORY;



-- 2.Comparación de rendimiento por país en regiones APAC y EMEA

SELECT A.REGION AS "REGIÓN", A.COUNTRY AS "PAÍS", S.TOTAL AS INGRESO_PROMEDIO, S.UNITS_SOLD AS UNIDADES_VENDIDAS_PROMEDIO, S.PROFIT AS BENEFICIO_PROMEDIO
FROM SALES AS s
JOIN ACCOUNTS AS A
ON S.ACCOUNT = A.ACCOUNT
WHERE A.REGION = 'APAC' OR A.REGION = 'EMEA';

-- QUERY SOLUCION:

SELECT 
A.REGION AS "REGIÓN", 
A.COUNTRY AS "PAÍS",
ROUND(AVG(S.PROFIT), 2) AS BENEFICIO_PROMEDIO,
ROUND(AVG(S.TOTAL),2) AS INGRESO_PROMEDIO, 
ROUND(AVG(S.UNITS_SOLD),2) AS UNIDADES_VENDIDAS_PROMEDIO 
FROM SALES AS s
JOIN ACCOUNTS AS A
ON S.ACCOUNT = A.ACCOUNT
WHERE A.REGION = 'APAC' OR A.REGION = 'EMEA'
GROUP BY REGION, COUNTRY
ORDER BY BENEFICIO_PROMEDIO DESC, INGRESO_PROMEDIO DESC;



-- 3.Análisis del beneficio total por industria: Estudio de clientes en etapa de compromiso.

SELECT DISTINCT ACCOUNT
FROM FORECASTS
WHERE PREDICTION_CATEGORY = 'Commit'
AND FORECAST > 500000;

--QUERY SOLUCION:

SELECT
INDUSTRY,
SUM(PROFIT) AS TOTAL_PROFIT,
CASE
    WHEN TOTAL_PROFIT > 1000000 THEN 'ALTO'
    ELSE 'NORMAL'
 END AS BENEFIT_CATEGORY

FROM SALES AS S
JOIN ACCOUNTS AS A
ON S.ACCOUNT = A.ACCOUNT

WHERE
S.ACCOUNT IN(
SELECT DISTINCT ACCOUNT
FROM FORECASTS
WHERE PREDICTION_CATEGORY = 'Commit'
AND FORECAST > 500000
)
GROUP BY INDUSTRY
ORDER BY TOTAL_PROFIT DESC;



-- 4.Evolución del pronóstico y beneficio real: Análisis de la trayectoria por categoría.

SELECT 
CATEGORY AS CATEGORIA, 
SUM(PROFIT) AS BENEFICIO_TOTAL_2021
FROM SALES
WHERE YEAR = 2021
GROUP BY CATEGORIA;

SELECT
CATEGORY AS CATEGORIA, 
SUM(FORECAST) AS PRONOSTICO_TOTAL_2022,
MIN(OPPORTUNITY_AGE) AS OPORTUNIDAD_MAS_RECIENTE,
MAX(OPPORTUNITY_AGE) AS OPORTUNIDAD_MAS_ANTIGUA
FROM FORECASTS
WHERE YEAR = 2022
GROUP BY CATEGORIA;

-- QUERY SOLUCION:

WITH PROFIT_2021 AS(
SELECT 
CATEGORY AS CATEGORIA, 
SUM(PROFIT) AS BENEFICIO_TOTAL_2021
FROM SALES
WHERE YEAR = 2021
GROUP BY CATEGORIA
),
FORECASTS_2022 AS(
SELECT
CATEGORY AS CATEGORIA, 
SUM(FORECAST) AS PRONOSTICO_TOTAL_2022,
MIN(OPPORTUNITY_AGE) AS OPORTUNIDAD_MAS_RECIENTE,
MAX(OPPORTUNITY_AGE) AS OPORTUNIDAD_MAS_ANTIGUA,
ROUND(AVG(OPPORTUNITY_AGE),2) AS MEDIA_OPORTUNIDADES
FROM FORECASTS
WHERE YEAR = 2022
GROUP BY CATEGORIA
)

SELECT
COALESCE(P.CATEGORIA, F.CATEGORIA) AS CATEGORIA,
    P.BENEFICIO_TOTAL_2021,
    F.PRONOSTICO_TOTAL_2022,
    F.OPORTUNIDAD_MAS_RECIENTE,
    F.OPORTUNIDAD_MAS_ANTIGUA,
    F.MEDIA_OPORTUNIDADES
FROM
PROFIT_2021 AS P
FULL OUTER JOIN
FORECASTS_2022 AS F
ON F.CATEGORIA = P.CATEGORIA
ORDER BY BENEFICIO_TOTAL_2021 DESC, PRONOSTICO_TOTAL_2022 DESC;


-- 1) CASO PRÁCTICO: Analisis del beneficio por producto VS servicios.

-- 2) Analisis exploratorio:

SELECT * FROM SALES;

-- 2.1) Exploracion general de ingresos y beneficio total

SELECT
    TO_VARCHAR(SUM(PRODUCT), '$999,999,999,999')     AS TOTAL_PRODUCTO,
    TO_VARCHAR(SUM(MAINTENANCE), '$999,999,999,999') AS TOTAL_MANTENIMIENTO,
    TO_VARCHAR(SUM(SUPPORT), '$999,999,999,999')     AS TOTAL_SOPORTE,
    TO_VARCHAR(SUM(PARTS), '$999,999,999,999')      AS TOTAL_PARTES,
    TO_VARCHAR(SUM(TOTAL), '$999,999,999,999')      AS TOTAL_INGRESOS,
    TO_VARCHAR(SUM(PROFIT), '$999,999,999,999')      AS TOTAL_BENEFICIO  
FROM SALES;

-- 2.2) Producto VS servicio

SELECT
    TO_VARCHAR(SUM(PRODUCT), '$999,999,999,999')     AS TOTAL_PRODUCTO,
    TO_VARCHAR(SUM(MAINTENANCE + SUPPORT + PARTS), '$999,999,999,999')     AS TOTAL_SERVICIOS,
    TO_VARCHAR(SUM(TOTAL), '$999,999,999,999')      AS TOTAL_INGRESOS
FROM SALES;

-- Relación ingresos beneficios

SELECT
    TO_VARCHAR(SUM(PRODUCT), '$999,999,999,999')     AS TOTAL_PRODUCTO,
    TO_VARCHAR(SUM(MAINTENANCE + SUPPORT + PARTS), '$999,999,999,999')     AS TOTAL_SERVICIOS,
    TO_VARCHAR(SUM(TOTAL), '$999,999,999,999')      AS TOTAL_INGRESOS,
    TO_VARCHAR(SUM(PROFIT), '$999,999,999,999')      AS TOTAL_BENEFICIO
FROM SALES;


-- 2.3)Exploración temporal

SELECT
    YEAR,
    TO_VARCHAR(SUM(PRODUCT), '$999,999,999,999')     AS TOTAL_PRODUCTO,
    TO_VARCHAR(SUM(MAINTENANCE + SUPPORT + PARTS), '$999,999,999,999')     AS TOTAL_SERVICIOS,
    TO_VARCHAR(SUM(TOTAL), '$999,999,999,999')      AS TOTAL_INGRESOS,
    TO_VARCHAR(SUM(PROFIT), '$999,999,999,999')      AS TOTAL_BENEFICIO
FROM SALES
GROUP BY YEAR
ORDER BY YEAR;

-- 3) QUERY FINAL: Respuesta a la pregunta de negocio

-- 3.1) Porcentaje de ingresos por producto frente a ingresos por servicios

SELECT
    TO_VARCHAR(SUM(PRODUCT), '$999,999,999,999')     AS INGRESOS_PRODUCTO,
    TO_VARCHAR(SUM(MAINTENANCE + SUPPORT + PARTS), '$999,999,999,999')     AS INGRESOS_SERVICIOS,    
    TO_VARCHAR(SUM(TOTAL), '$999,999,999,999')      AS TOTAL_INGRESOS,
    
    ROUND(SUM(PRODUCT) / SUM(TOTAL) * 100, 2) AS PORCENTAJE_PRODUCTO,
    ROUND((SUM(MAINTENANCE + SUPPORT + PARTS)) / SUM(TOTAL) * 100, 2 ) AS PORCENTAJE_SERVICIOS,
    TO_VARCHAR(SUM(PROFIT), '$999,999,999,999')      AS TOTAL_BENEFICIO
FROM SALES;



-- 3.2) Ingresos por producto, por servicio, ingresos totales, porcentaje y beneficio total de cada industria

SELECT
A.INDUSTRY AS INDUSTRIA,
    TO_VARCHAR(SUM(S.PRODUCT), '$999,999,999,999')     AS INGRESOS_PRODUCTO_INDUSTRIA,
    TO_VARCHAR(SUM(MAINTENANCE + SUPPORT + PARTS), '$999,999,999,999')     AS INGRESOS_SERVICIOS_INDUSTRIA,
    TO_VARCHAR(SUM(S.TOTAL), '$999,999,999,999')      AS TOTAL_INGRESOS_INDUSTRIA,
    ROUND((SUM(S.PRODUCT)) / SUM(S.TOTAL) * 100, 2 ) AS PORCENTAJE_PRODUCTO_INDUSTRIA,
    TO_VARCHAR(SUM(PROFIT), '$999,999,999,999')      AS TOTAL_BENEFICIO
FROM SALES AS S
JOIN
ACCOUNTS AS A
ON S.ACCOUNT = A.ACCOUNT
GROUP BY A.INDUSTRY
ORDER BY INGRESOS_PRODUCTO_INDUSTRIA DESC
LIMIT 10;



-- 3.3) Industrias que mas ingresos aportan por servicios

SELECT
A.INDUSTRY AS INDUSTRIA,
    TO_VARCHAR(SUM(S.MAINTENANCE + S.SUPPORT + S.PARTS), '$999,999,999,999')     AS INGRESOS_SERVICIOS_INDUSTRIA,
    TO_VARCHAR(SUM(S.TOTAL), '$999,999,999,999')      AS TOTAL_INGRESOS_INDUSTRIA,
    ROUND((SUM(S.MAINTENANCE + S.SUPPORT + S.PARTS)) / SUM(S.TOTAL) * 100, 2 ) AS PORCENTAJE_SERVICIOS_INDUSTRIA,
    TO_VARCHAR(SUM(PROFIT), '$999,999,999,999')      AS TOTAL_BENEFICIO_INDUSTRIA
FROM SALES AS S
JOIN
ACCOUNTS AS A
ON S.ACCOUNT = A.ACCOUNT
GROUP BY A.INDUSTRY
ORDER BY INGRESOS_SERVICIOS_INDUSTRIA DESC
LIMIT 10;



-- Industrias que mas ingresos aportan por producto

SELECT
A.INDUSTRY AS INDUSTRIA,
    TO_VARCHAR(SUM(S.PRODUCT), '$999,999,999,999')     AS INGRESOS_PRODUCTO_INDUSTRIA,
    TO_VARCHAR(SUM(S.TOTAL), '$999,999,999,999')      AS TOTAL_INGRESOS_INDUSTRIA,
    ROUND((SUM(S.PRODUCT)) / SUM(S.TOTAL) * 100, 2 ) AS PORCENTAJE_PRODUCTO_INDUSTRIA,
    TO_VARCHAR(SUM(PROFIT), '$999,999,999,999')      AS TOTAL_BENEFICIO_INDUSTRIA
FROM SALES AS S
JOIN
ACCOUNTS AS A
ON S.ACCOUNT = A.ACCOUNT
GROUP BY A.INDUSTRY
ORDER BY INGRESOS_PRODUCTO_INDUSTRIA DESC
LIMIT 10;



-- 3.4) Ingresos por producto, por servicio, ingresos totales, porcentaje y beneficio total de cada empresa

SELECT
ACCOUNT AS EMPRESAS,
    TO_VARCHAR(SUM(PRODUCT), '$999,999,999,999')     AS INGRESOS_PRODUCTO_EMPRESAS,
    TO_VARCHAR(SUM(MAINTENANCE + SUPPORT + PARTS), '$999,999,999,999')     AS INGRESOS_SERVICIOS_EMPRESAS,
    TO_VARCHAR(SUM(TOTAL), '$999,999,999,999')      AS TOTAL_INGRESOS_EMPRESAS,
    ROUND(SUM(PRODUCT) / SUM(TOTAL) * 100, 2) AS PORCENTAJE_PRODUCTO_EMPRESAS,
    TO_VARCHAR(SUM(PROFIT), '$999,999,999,999')      AS TOTAL_BENEFICIO_EMPRESAS
FROM SALES
GROUP BY ACCOUNT
ORDER BY TOTAL_INGRESOS_EMPRESAS DESC
LIMIT 10;



-- 3.5) Empresas que aportan mas ingresos por servicios

SELECT
ACCOUNT AS EMPRESAS,
    TO_VARCHAR(SUM(MAINTENANCE + SUPPORT + PARTS), '$999,999,999,999')     AS INGRESOS_SERVICIOS_EMPRESAS,
    TO_VARCHAR(SUM(TOTAL), '$999,999,999,999')      AS TOTAL_INGRESOS_EMPRESAS,
    ROUND((SUM(MAINTENANCE + SUPPORT + PARTS)) / SUM(TOTAL) * 100, 2 ) AS PORCENTAJE_SERVICIOS_EMPRESAS,
    TO_VARCHAR(SUM(PROFIT), '$999,999,999,999')      AS TOTAL_BENEFICIO_EMPRESAS
FROM SALES
GROUP BY ACCOUNT
ORDER BY INGRESOS_SERVICIOS_EMPRESAS DESC
LIMIT 10;



-- Empresas que aportan mas ingresos por producto

SELECT
ACCOUNT AS EMPRESAS,
    TO_VARCHAR(SUM(PRODUCT), '$999,999,999,999')     AS INGRESOS_PRODUCTO_EMPRESAS,
    TO_VARCHAR(SUM(TOTAL), '$999,999,999,999')      AS TOTAL_INGRESOS_EMPRESAS,
    ROUND(SUM(PRODUCT) / SUM(TOTAL) * 100, 2) AS PORCENTAJE_PRODUCTO_EMPRESAS,
    TO_VARCHAR(SUM(PROFIT), '$999,999,999,999')      AS TOTAL_BENEFICIO_EMPRESAS
FROM SALES
GROUP BY ACCOUNT
ORDER BY INGRESOS_PRODUCTO_EMPRESAS DESC
LIMIT 10;



-- 3.6) Margen de beneficios global + porcentaje

SELECT
    TO_VARCHAR(SUM(TOTAL), '$999,999,999,999') AS INGRESOS_TOTALES,
    TO_VARCHAR(SUM(PROFIT), '$999,999,999,999') AS BENEFICIO_TOTAL,
    ROUND(SUM(PROFIT) / NULLIF(SUM(TOTAL), 0) * 100,2) AS MARGEN_BENEFICIO_PORCENTAJE
FROM SALES;



-- 3.7) Margen de beneficios por industria + porcentaje

SELECT
A.INDUSTRY AS INDUSTRIA,
    TO_VARCHAR(SUM(TOTAL), '$999,999,999,999') AS INGRESOS_TOTALES_INDUSTRIA,
    TO_VARCHAR(SUM(PROFIT), '$999,999,999,999') AS BENEFICIO_TOTAL_INDUSTRIA,
    ROUND(SUM(PROFIT) / NULLIF(SUM(TOTAL), 0) * 100,2) AS MARGEN_BENEFICIO_PORCENTAJE
FROM SALES AS S
JOIN ACCOUNTS AS A
ON S.ACCOUNT = A.ACCOUNT
GROUP BY INDUSTRIA
ORDER BY MARGEN_BENEFICIO_PORCENTAJE DESC;





